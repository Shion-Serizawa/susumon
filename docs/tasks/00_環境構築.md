# タスク計画: 環境構築（Phase 0）

**目的**: ローカル開発環境とデプロイ環境の基盤を構築する

**完了条件**:
- ローカルで開発サーバーが起動できる
- データベース接続が確立できる
- 認証システム（モック）が動作する
- ビルドが成功する

**並列実行**: このフェーズ完了後、フロントエンド開発とバックエンド開発が並列実行可能

---

## タスク一覧

### 1. プロジェクト初期化

- [x] **1.1 SvelteKit プロジェクト作成**
  - `npx sv create` で Svelte 5 + TypeScript 構成を選択
  - `@deno/svelte-adapter` をインストール
  - `svelte.config.js` を設定
  - **依存**: なし
  - **成果物**: `package.json`, `svelte.config.js`

- [x] **1.2 Deno 設定ファイル作成**
  - `deno.json` を作成（tasks, compilerOptions 設定）
  - `deno.lock` を生成
  - **依存**: 1.1
  - **成果物**: `deno.json`, `deno.lock`

- [x] **1.3 プロジェクト構造の確立**
  ```
  src/
  ├── lib/
  │   ├── components/      # Svelte コンポーネント
  │   ├── server/          # サーバー専用コード
  │   └── types/           # 型定義
  ├── routes/
  │   ├── (app)/           # 認証後のアプリ
  │   └── api/             # API エンドポイント
  └── hooks.server.ts      # 認証フック
  ```
  - **依存**: 1.2
  - **成果物**: ディレクトリ構造

### 2. データベースセットアップ

- [x] **2.1 Prisma スキーマ定義**
  - `prisma/schema.prisma` を作成
  - `runtime = "deno"` を設定（必須）
  - 3テーブル定義: `themes`, `learning_log_entries`, `meta_notes`
  - `meta_notes.category` は Prisma の Enum で表現（DB 制約 + TS 側の型）
  - **依存**: 1.3
  - **成果物**: `prisma/schema.prisma`
  - **参照**: `docs/spec/learning_log_meta_note_アプリ_db設計（draft_v_0.md`

- [x] **2.2 ローカル DB セットアップ**
  - Docker Compose で PostgreSQL 起動
  - 初回マイグレーション作成/適用: `deno task db:migrate:dev`
  - Prisma Client 生成: `deno task db:generate`
  - **依存**: 2.1
  - **成果物**: `prisma/migrations/`, `generated/prisma/`

- [x] **2.3 DB接続ユーティリティ作成**
  - `src/lib/server/db.ts` - Prisma Client シングルトン
  - 開発環境でのホットリロード対応
  - **依存**: 2.2
  - **成果物**: `src/lib/server/db.ts`

- [x] **2.4 DB 制約の確認（ローカル）**
  - `MetaNote.category`（Enum）の DB 制約が反映されていることを確認
  - `uq_log_per_day`（1日1テーマ1ログ）や FK 制約が反映されていることを確認
  - **依存**: 2.2
  - **成果物**: なし（検証のみ）

### 3. 認証システム（モック）

- [x] **3.1 モック認証実装**
  - `src/lib/server/auth-mock.ts` - 固定ユーザー定義
  - **依存**: なし
  - **成果物**: `src/lib/server/auth-mock.ts`
  - **参照**: `docs/setup/MOCK_AUTH.md`

- [x] **3.2 認証フック実装**
  - `src/hooks.server.ts` - `locals.user` 設定
  - `USE_MOCK_AUTH` 環境変数での切り替え
  - **依存**: 3.1
  - **成果物**: `src/hooks.server.ts`

- [x] **3.3 型定義追加**
  - `src/app.d.ts` - `App.Locals` 型定義
  - **依存**: 3.2
  - **成果物**: `src/app.d.ts`

### 3.4 認証システム（本実装の下準備）

- [x] **3.4.1 認証ルーティングの骨組み**
  - `(auth)` グループルートを用意（`/login`, `/auth/callback`）
  - `app/` パスセグメントを用意（認証後エリア）
  - **依存**: 3.3
  - **成果物**: `src/routes/(auth)/`, `src/routes/app/`

- [x] **3.4.2 セッション確認 API の作成**
  - `/api/auth/session`（`locals.user` の確認用）を用意
  - **依存**: 3.3
  - **成果物**: `src/routes/api/auth/session/+server.ts`

- [x] **3.4.3 Supabase Auth 実装の段取りを固める**
  - Cookie 名、トークン更新、ログアウトなどの方針を `docs/setup/` 側に追記
  - **依存**: 3.4.1
  - **成果物**: `docs/setup/SUPABASE_AUTH.md`, `.env.example` の更新

### 4. 共通ユーティリティ

- [x] **4.1 型定義ファイル作成**
  - `src/lib/types/index.ts` - ドメイン型定義
  - Theme, LearningLogEntry, MetaNote 型
  - **依存**: 2.1
  - **成果物**: `src/lib/types/index.ts`
  - **参照**: `docs/spec/learning_log_meta_note_アプリ_機能仕様（draft_v_0.md`

- [x] **4.2 UUID v7 生成ユーティリティ**
  - `src/lib/server/uuid.ts` - `uuidv7()` ラッパー
  - **依存**: なし
  - **成果物**: `src/lib/server/uuid.ts`

- [x] **4.3 日付処理ユーティリティ**
  - `src/lib/utils/date.ts` - JST 日付処理
  - 現在のJST日付取得、フォーマット関数
  - **依存**: なし
  - **成果物**: `src/lib/utils/date.ts`

### 4.4 ルーティング/API 構造（最小）を先に作る

- [x] **4.4.1 API ディレクトリの骨組み**
  - `src/routes/api/` の骨組み作成（認証/ヘルスチェックなど最初に必要なものから）
  - **依存**: 1.3
  - **成果物**: `src/routes/api/`

### 5. 開発環境整備

- [x] **5.1 環境変数設定**
  - `.env.example` は作成済み
  - `.env` を作成（ローカル設定）
  - **依存**: 2.2
  - **成果物**: `.env`

- [x] **5.2 開発サーバー起動確認**
  - `deno task dev` で起動
  - http://localhost:5173 でアクセス確認
  - **依存**: 全タスク
  - **成果物**: なし（検証のみ）

- [x] **5.3 ビルド確認**
  - `deno task build` でビルド成功確認
  - **依存**: 全タスク
  - **成果物**: `.svelte-kit/output/`

---

## 完了チェックリスト

全タスク完了後、以下を確認：

- [x] `deno task dev` で開発サーバーが起動する
- [x] データベースに接続できる（マイグレーション適用済み）
- [x] `locals.user` にモックユーザーが設定される（hooks.server.ts）
- [x] TypeScript 型チェックがエラーなく通る
- [x] ビルドが成功する（@deno/svelte-adapter使用）

---

## 次フェーズへの引き継ぎ

### フロントエンド開発（Phase 1-FE）へ
- **前提条件**: このフェーズ完了
- **利用可能**: 型定義（`src/lib/types/`）、認証状態（`locals.user`）
- **API契約**: `docs/spec/learning_log_meta_note_アプリ_技術仕様（final_v_0.md` のOpenAPI定義を参照

### バックエンド開発（Phase 1-BE）へ
- **前提条件**: このフェーズ完了
- **利用可能**: Prisma Client、認証フック、UUIDユーティリティ
- **実装規約**: `CLAUDE.md` のコーディング規約（C-1〜C-6）を遵守

---

## トラブルシューティング

### よくある問題

**問題**: Prisma Client 生成時に `runtime = "deno"` エラー
- **解決**: `prisma/schema.prisma` の generator に `runtime = "deno"` が設定されているか確認

**問題**: 開発サーバー起動時に型エラー
- **解決**: `deno task db:generate` を実行して Prisma Client を再生成

**問題**: モック認証が動作しない
- **解決**: `.env` に `USE_MOCK_AUTH=true` が設定されているか確認
