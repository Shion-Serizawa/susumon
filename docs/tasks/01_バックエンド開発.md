
# タスク計画: バックエンド開発（Phase 1-BE）

**目的**: REST APIエンドポイントの実装とビジネスロジックの構築

**前提条件**: Phase 0（環境構築）完了

**並列実行**: フロントエンド開発（Phase 1-FE）と並列実行可能

**API契約**: `docs/spec/learning_log_meta_note_アプリ_技術仕様（final_v_0.md` のOpenAPI定義に準拠

---

## 実装規約（必須遵守）

すべてのAPIエンドポイント実装時に以下を遵守：

- **C-1 (MUST)**: `locals.user` で認証チェック、`userId` でスコープ制限
  - **重要**: Prisma Client Extensions（`src/lib/server/db.ts`）が自動で`userId`チェックと`state != 'DELETED'`フィルタを適用
- **C-2 (MUST)**: ドメイン用語を統一（theme, log, note）
- **C-3 (MUST)**: エラーレスポンス統一フォーマット `{ error: { code, message } }`
- **C-4 (MUST)**: 日付処理は JST ローカル日付（`YYYY-MM-DD`）
- **C-5 (SHOULD)**: Pagination はカーソル方式（Base64 JSON）
- **DB-3 (v0.2)**: UUID v7 はDB側で自動生成（`uuid_v7()`関数）、アプリ側でのID生成は**不要**
- **DB-2 (v0.2)**: 論理削除（State Machine方式）、`state = 'DELETED'`にUPDATE

**参照**: `CLAUDE.md` の Standards > While Coding (C) および Database (DB)

---

## タスク一覧

**実装順序の方針**:
1. **セクション 1-3**: Theme/Log/Note APIを先に実装（モック認証使用）
2. **セクション 4**: 全API完成後にSupabase Auth実装（本番デプロイ前）

この順序により、OAuth設定なしでAPI開発に集中でき、テストも高速に実行できます。

### セクション 1: Theme API（テーマ管理）

**依存**: Phase 0 完了

- [x] **1.1 GET /api/themes - テーマ一覧取得**
  - ユーザースコープでテーマ取得
  - `isCompleted` フィルタ対応
  - カーソルページネーション実装
  - 並び順: `created_at asc, id asc`
  - **依存**: Phase 0
  - **成果物**: `src/routes/api/themes/+server.ts` (GET handler)
  - **並列可能**: フロントエンド 1.1（テーマ一覧UI）

- [x] **1.2 POST /api/themes - テーマ作成**
  - リクエストボディバリデーション
  - **UUID v7 はDB側で自動生成**（Prismaスキーマの`@default(dbgenerated("uuid_v7()"))`）
  - 一意制約違反ハンドリング
  - **依存**: 1.1
  - **成果物**: `src/routes/api/themes/+server.ts` (POST handler)
  - **並列可能**: フロントエンド 1.2（テーマ作成フォーム）

- [x] **1.3 GET /api/themes/[id] - テーマ詳細取得**
  - ユーザースコープ検証
  - 404エラーハンドリング
  - **依存**: 1.1
  - **成果物**: `src/routes/api/themes/[id]/+server.ts` (GET)
  - **並列可能**: フロントエンド 1.3（テーマ詳細ページ）

- [x] **1.4 PATCH /api/themes/[id] - テーマ更新**
  - 部分更新対応
  - ユーザースコープ検証
  - **依存**: 1.3
  - **成果物**: `src/routes/api/themes/[id]/+server.ts` (PATCH)
  - **並列可能**: フロントエンド 1.4（テーマ編集フォーム）

- [x] **1.5 DELETE /api/themes/[id] - テーマ削除**
  - **論理削除実装（v0.2仕様）**: `state = 'DELETED'` に UPDATE
  - カスケード削除確認（関連ログ・ノートの`state`も`'DELETED'`に更新）
  - **依存**: 1.3
  - **成果物**: `src/routes/api/themes/[id]/+server.ts` (DELETE)
  - **並列可能**: フロントエンド 1.5（削除確認ダイアログ）

**セクション1完了条件**:
- [x] 全エンドポイントが OpenAPI 仕様に準拠
- [x] ユーザースコープ制限が全エンドポイントで機能
- [x] エラーハンドリングが統一フォーマット

---

### セクション 2: LearningLog API（学習ログ管理）

**依存**: Theme API 完了（外部キー制約のため）

- [ ] **2.1 GET /api/logs - ログ一覧取得**
  - ユーザースコープでログ取得
  - `themeId`, `startDate`, `endDate` フィルタ対応
  - カーソルページネーション実装
  - 並び順: `date desc, created_at desc, id desc`
  - **依存**: 1.1 (Theme API)
  - **成果物**: `src/routes/api/logs/+server.ts` (GET)
  - **並列可能**: フロントエンド 2.1（ログ一覧UI）

- [ ] **2.2 POST /api/logs - ログ作成**
  - リクエストボディバリデーション
  - **UUID v7 はDB側で自動生成**
  - 1日1テーマ1ログ制約チェック（P2002エラー）
  - 外部キー制約エラーハンドリング（P2003）
  - **依存**: 2.1
  - **成果物**: `src/routes/api/logs/+server.ts` (POST)
  - **並列可能**: フロントエンド 2.2（ログ作成フォーム）

- [ ] **2.3 GET /api/logs/[id] - ログ詳細取得**
  - ユーザースコープ検証
  - テーマ情報も含めて返却（Prisma include）
  - **依存**: 2.1
  - **成果物**: `src/routes/api/logs/[id]/+server.ts` (GET)
  - **並列可能**: フロントエンド 2.3（ログ詳細ページ）

- [ ] **2.4 PATCH /api/logs/[id] - ログ更新**
  - 部分更新対応
  - `date`, `themeId` 変更時の一意制約チェック
  - **依存**: 2.3
  - **成果物**: `src/routes/api/logs/[id]/+server.ts` (PATCH)
  - **並列可能**: フロントエンド 2.4（ログ編集フォーム）

- [ ] **2.5 DELETE /api/logs/[id] - ログ削除**
  - **論理削除実装（v0.2仕様）**: `state = 'DELETED'` に UPDATE
  - 関連メタノートの `relatedLogId` は NULL に設定される（ON DELETE SET NULL）
  - **依存**: 2.3
  - **成果物**: `src/routes/api/logs/[id]/+server.ts` (DELETE)
  - **並列可能**: フロントエンド 2.5（削除確認ダイアログ）

**セクション2完了条件**:
- [ ] 1日1テーマ1ログ制約が機能
- [ ] 外部キー制約エラーが適切にハンドリングされる
- [ ] 日付フィルタが正しく動作

---

### セクション 3: MetaNote API（メタノート管理）

**依存**: LearningLog API 完了（`relatedLogId` 参照のため）

**注意事項（v0.2重要変更）**:
- `noteDate` はサーバー側で自動生成（作成時のJST日付）
- `category` のDB値は英語キー（`'INSIGHT' | 'QUESTION' | 'EMOTION'`）
- テーマとの関連は中間テーブル `meta_note_themes` を使用（配列フィールド廃止）

- [ ] **3.1 GET /api/notes - ノート一覧取得**
  - ユーザースコープでノート取得
  - `category`, `themeIds`, `startDate`, `endDate` フィルタ対応
    - `themeIds` フィルタは中間テーブル経由で検索
  - カーソルページネーション実装
  - 並び順: `note_date desc, created_at desc, id desc`
  - **依存**: 2.1 (Log API)
  - **成果物**: `src/routes/api/notes/+server.ts` (GET)
  - **並列可能**: フロントエンド 3.1（ノート一覧UI）

- [ ] **3.2 POST /api/notes - ノート作成**
  - リクエストボディバリデーション（`noteDate` は不要）
  - **UUID v7 はDB側で自動生成**
  - **サーバー側で `noteDate` を自動設定**（重要！）
  - `category` の値チェック（**DB値**: `'INSIGHT' | 'QUESTION' | 'EMOTION'`）
  - `themeIds` の存在確認と中間テーブル `meta_note_themes` への挿入
  - `relatedLogId` の存在確認（任意フィールド）
  - **依存**: 3.1
  - **成果物**: `src/routes/api/notes/+server.ts` (POST)
  - **並列可能**: フロントエンド 3.2（ノート作成フォーム）

- [ ] **3.3 GET /api/notes/[id] - ノート詳細取得**
  - ユーザースコープ検証
  - 関連ログ情報とテーマ情報も含めて返却（Prisma include + 中間テーブル）
  - **依存**: 3.1
  - **成果物**: `src/routes/api/notes/[id]/+server.ts` (GET)
  - **並列可能**: フロントエンド 3.3（ノート詳細ページ）

- [ ] **3.4 PATCH /api/notes/[id] - ノート更新**
  - 部分更新対応
  - **`noteDate` は更新不可**（仕様確認）
  - `category` の値チェック（`'INSIGHT' | 'QUESTION' | 'EMOTION'`）
  - `themeIds` 更新時は中間テーブル `meta_note_themes` を削除＆再挿入
  - `relatedLogId` の検証
  - **依存**: 3.3
  - **成果物**: `src/routes/api/notes/[id]/+server.ts` (PATCH)
  - **並列可能**: フロントエンド 3.4（ノート編集フォーム）

- [ ] **3.5 DELETE /api/notes/[id] - ノート削除**
  - **論理削除実装（v0.2仕様）**: `state = 'DELETED'` に UPDATE
  - 中間テーブル `meta_note_themes` のレコードは自動的にカスケード削除される
  - **依存**: 3.3
  - **成果物**: `src/routes/api/notes/[id]/+server.ts` (DELETE)
  - **並列可能**: フロントエンド 3.5（削除確認ダイアログ）

**セクション3完了条件**:
- [ ] `noteDate` がサーバー側で自動生成される
- [ ] `category` の値が制約に準拠（英語キー）
- [ ] 中間テーブル `meta_note_themes` が正しく処理される

---

### セクション 4: 認証基盤（本番デプロイ前）

**依存**: セクション 1-3 完了（全API実装完了後）

**実装タイミング**: Theme/Log/Note APIが完成し、本番デプロイを検討する段階

**注意**: Phase 0で既に以下を実装済み：
- ✅ `/api/auth/session` エンドポイント（モック認証対応）
- ✅ モック認証（`hooks.server.ts`）
- ✅ Supabase Auth 実装ガイド（`docs/setup/SUPABASE_AUTH.md`）

- [ ] **4.1 Supabase プロジェクトのセットアップ**
  - Supabase Dashboard でプロジェクト作成
  - GitHub OAuth App 作成（GitHub Developer Settings）
  - Supabase に GitHub OAuth 設定
  - 環境変数設定（`SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`）
  - **依存**: なし
  - **成果物**: Supabase プロジェクト、GitHub OAuth App
  - **参照**: `docs/setup/SUPABASE_AUTH.md` のセットアップ手順

- [ ] **4.2 Cookie管理ユーティリティ作成**
  - `src/lib/server/auth.ts` - Cookie管理関数
    - `setAuthCookie()` - セッションをCookieに保存
    - `getAuthCookie()` - CookieからセッションJSON取得
    - `deleteAuthCookie()` - Cookie削除
    - `refreshSession()` - refresh_tokenで新しいaccess_token取得
  - **依存**: 4.1
  - **成果物**: `src/lib/server/auth.ts`
  - **参照**: `docs/setup/SUPABASE_AUTH.md` のCookie管理セクション

- [ ] **4.3 hooks.server.ts の更新（Supabase Auth対応）**
  - Cookie からセッション取得
  - トークン有効期限チェック（5分前に自動更新）
  - Supabase でユーザー情報取得
  - `locals.user` 設定
  - モック認証との切り替えロジック（`USE_MOCK_AUTH`環境変数）
  - 本番環境でのモック認証無効化チェック
  - **依存**: 4.2
  - **成果物**: `src/hooks.server.ts` 更新
  - **参照**: `docs/setup/SUPABASE_AUTH.md` の hooks 実装例

- [ ] **4.4 認証APIエンドポイント実装**
  - **4.4.1**: `POST /api/auth/login` - GitHub OAuth 開始
  - **4.4.2**: `GET /auth/callback` - OAuth コールバック処理、Cookie設定
  - **4.4.3**: `POST /api/auth/logout` - Cookie 削除、Supabase セッション無効化
  - **4.4.4**: `GET /api/auth/session` 更新（Supabase Auth完全対応）
  - **依存**: 4.3
  - **成果物**: `src/routes/api/auth/login/+server.ts`, `src/routes/auth/callback/+server.ts`, `src/routes/api/auth/logout/+server.ts`, `src/routes/api/auth/session/+server.ts`
  - **参照**: `docs/setup/SUPABASE_AUTH.md` の API エンドポイント実装例

- [ ] **4.5 認証フローの動作確認**
  - ローカル環境でログイン/ログアウトテスト
  - トークン自動更新の確認
  - Cookie セキュリティ設定確認（HttpOnly, Secure, SameSite）
  - **依存**: 4.4
  - **成果物**: なし（検証のみ）

**セクション4完了条件**:
- [ ] GitHub OAuth ログインが動作する
- [ ] トークンが自動更新される
- [ ] ログアウトが正常に動作する
- [ ] モック認証と本番認証の切り替えが正常に動作する
- [ ] 本番環境でモック認証が無効化される

---

## 共通実装パターン

すべてのエンドポイントで以下のパターンを使用：

### 認証チェック（必須）

```typescript
export const GET: RequestHandler = async ({ locals }) => {
  if (!locals.user) {
    return json(
      { error: { code: 'Unauthorized', message: 'Authentication required' } },
      { status: 401 }
    );
  }
  // ...
};
```

### ユーザースコープ制限（必須）

```typescript
// Prisma Client Extensions（src/lib/server/db.ts）が自動で userId チェックを適用
const items = await prisma.resource.findMany({
  where: { userId: locals.user.id }, // 必須（自動検証あり）
});

// userId を省略すると SECURITY エラーが発生
// Error: "SECURITY: Resource.findMany requires userId in where clause"
```

### UUID v7 生成（v0.2: DB側で自動生成）

```typescript
// v0.2 では UUID v7 はDB側で自動生成されるため、アプリ側での指定は不要
const created = await prisma.resource.create({
  data: {
    // id: uuidv7(), // ❌ 不要（DB側で自動採番）
    userId: locals.user.id,
    // ...
  },
});

// Prisma スキーマに @default(dbgenerated("uuid_v7()")) を設定済み
```

### 論理削除（v0.2: State Machine方式）

```typescript
// 削除は UPDATE で state を変更
await prisma.resource.update({
  where: { id, userId: locals.user.id },
  data: { state: 'DELETED' },
});

// Prisma Client Extensions が自動的に state != 'DELETED' をフィルタ
// 通常のクエリでは削除済みリソースは取得されない
const items = await prisma.resource.findMany({
  where: { userId: locals.user.id },
  // 自動的に AND state != 'DELETED' が追加される
});
```

### エラーハンドリング

```typescript
try {
  // ...
} catch (error) {
  // 一意制約違反
  if (error.code === 'P2002') {
    return json(
      { error: { code: 'Conflict', message: 'Resource already exists' } },
      { status: 409 }
    );
  }
  // 外部キー制約違反
  if (error.code === 'P2003') {
    return json(
      { error: { code: 'BadRequest', message: 'Referenced resource not found' } },
      { status: 400 }
    );
  }
  throw error;
}
```

---

## テスト計画

各セクション完了後、以下をテスト：

### 手動テスト（必須）

**セクション 1-3（モック認証使用）**:
- [ ] **Theme API**: Prisma Studio または curl で CRUD 操作確認
- [ ] **Log API**: 1日1テーマ1ログ制約が機能することを確認
- [ ] **Note API**: `noteDate` が自動生成されることを確認

**セクション 4（Supabase Auth）**:
- [ ] **認証フロー**: ログイン → Cookie設定 → ログアウトの一連の流れを確認
- [ ] **トークン更新**: 有効期限が近づくと自動更新されることを確認

### 自動テスト（推奨）

- [ ] 統合テスト: 各エンドポイントの正常系・異常系
- [ ] ユーザースコープテスト: 他ユーザーのデータにアクセスできないことを確認

**参照**: `.claude/commands/test-e2e.md`

---

## 完了チェックリスト

全タスク完了後、以下を確認：

**セクション 1-3（API実装）**:
- [ ] すべてのエンドポイントが OpenAPI 仕様に準拠
- [ ] エラーレスポンスが統一フォーマット
- [ ] ユーザースコープ制限が全エンドポイントで機能
- [ ] 一意制約・外部キー制約エラーが適切にハンドリングされる
- [ ] UUID v7 がDB側で自動生成される
- [ ] 論理削除（`state = 'DELETED'`）が正しく動作する
- [ ] カーソルページネーションが正しく動作する

**セクション 4（認証基盤）**:
- [ ] GitHub OAuth ログインが動作する
- [ ] Cookie のセキュリティ設定が適切（HttpOnly, Secure, SameSite）
- [ ] トークン自動更新が動作する
- [ ] ログアウトが正常に動作する
- [ ] モック認証と本番認証の切り替えが正常

---

## フロントエンド開発との連携

### API契約の確認

フロントエンド開発チームは以下を参照：

- **OpenAPI定義**: `docs/spec/learning_log_meta_note_アプリ_技術仕様（final_v_0.md:69`
- **型定義**: `src/lib/types/index.ts`

### 並列開発時の注意点

1. **インターフェース変更時**: フロントエンドチームに通知
2. **エラーコード追加**: 統一フォーマットを維持
3. **ページネーション**: `nextCursor` の形式を変更しない

---

## トラブルシューティング

### よくある問題

**問題**: Prisma エラー `P2002` (一意制約違反)
- **解決**: 既存データとの重複を確認、適切なエラーレスポンスを返す

**問題**: `noteDate` がフロントエンドから送信される
- **解決**: リクエストボディから `noteDate` を除外、サーバー側で生成

**問題**: ユーザースコープ漏れ
- **解決**: すべてのクエリに `where: { userId: locals.user.id }` を追加
- **注意**: Prisma Client Extensionsが自動検証するが、明示的に指定すること

**問題**: UUID v7 をアプリ側で生成してしまう
- **解決**: v0.2ではDB側で自動生成されるため、`id`フィールドを指定しない

**問題**: 物理削除を実装してしまう
- **解決**: v0.2では論理削除（`state = 'DELETED'`）を使用

**問題**: MetaNoteの`category`に日本語（'気づき'等）を使用
- **解決**: DB値は英語キー（`'INSIGHT' | 'QUESTION' | 'EMOTION'`）を使用

**問題**: MetaNoteの`themeIds`を配列フィールドとして処理
- **解決**: v0.2では中間テーブル`meta_note_themes`を使用

**参照**: `CLAUDE.md` の Gotchas & Pitfalls、`docs/spec/CHANGELOG_v0.2.md`
