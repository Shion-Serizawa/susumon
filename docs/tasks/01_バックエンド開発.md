# タスク計画: バックエンド開発（Phase 1-BE）

**目的**: REST APIエンドポイントの実装とビジネスロジックの構築

**前提条件**: Phase 0（環境構築）完了

**並列実行**: フロントエンド開発（Phase 1-FE）と並列実行可能

**API契約**: `docs/spec/learning_log_meta_note_アプリ_技術仕様（final_v_0.md` のOpenAPI定義に準拠

---

## 実装規約（必須遵守）

すべてのAPIエンドポイント実装時に以下を遵守：

- **C-1 (MUST)**: `locals.user` で認証チェック、`userId` でスコープ制限
- **C-2 (MUST)**: ドメイン用語を統一（theme, log, note）
- **C-3 (MUST)**: エラーレスポンス統一フォーマット `{ error: { code, message } }`
- **C-4 (MUST)**: 日付処理は JST ローカル日付（`YYYY-MM-DD`）
- **C-5 (SHOULD)**: Pagination はカーソル方式（Base64 JSON）
- **UUID v7**: 必ずアプリ側で生成（`uuidv7()`）

**参照**: `CLAUDE.md` の Standards > While Coding (C)

---

## タスク一覧

### セクション 0: 認証・基盤（バックエンドの最初）

**依存**: Phase 0 完了

- [ ] **0.1 GET /api/auth/session - セッション確認**
  - `locals.user` の認証チェック
  - 認証済みならユーザー情報を返す
  - **依存**: Phase 0
  - **成果物**: `src/routes/api/auth/session/+server.ts`

- [ ] **0.3 Supabase Auth の本実装（hooks + cookie）**
  - `hooks.server.ts` で Cookie からトークン取得 → Supabase で検証 → `locals.user` 設定
  - ログアウト時の cookie 破棄も含め方針を確定
  - **依存**: 0.1
  - **成果物**: `src/hooks.server.ts`（更新）, `src/lib/server/auth/*`（必要なら追加）

- [ ] **0.4 認証関連 API の追加（必要になったら）**
  - `/api/auth/logout`（cookie 破棄）
  - `/api/auth/callback`（PKCE / code exchange をどこでやるかは方針次第）
  - **依存**: 0.3
  - **成果物**: `src/routes/api/auth/*`

- [ ] **0.2 エラーレスポンス共通化（最小）**
  - `{ error: { code, message } }` を全 API で統一する方針の確認
  - （実装は必要になったタイミングで共通関数化）
  - **依存**: 0.1
  - **成果物**: なし（方針確定）

### セクション 1: Theme API（テーマ管理）

**依存**: Phase 0 完了

- [ ] **1.1 GET /api/themes - テーマ一覧取得**
  - ユーザースコープでテーマ取得
  - `isCompleted` フィルタ対応
  - カーソルページネーション実装
  - 並び順: `created_at asc, id asc`
  - **依存**: Phase 0
  - **成果物**: `src/routes/api/themes/+server.ts` (GET handler)
  - **並列可能**: フロントエンド 1.1（テーマ一覧UI）

- [ ] **1.2 POST /api/themes - テーマ作成**
  - リクエストボディバリデーション
  - UUID v7 生成
  - 一意制約違反ハンドリング
  - **依存**: 1.1
  - **成果物**: `src/routes/api/themes/+server.ts` (POST handler)
  - **並列可能**: フロントエンド 1.2（テーマ作成フォーム）

- [ ] **1.3 GET /api/themes/[id] - テーマ詳細取得**
  - ユーザースコープ検証
  - 404エラーハンドリング
  - **依存**: 1.1
  - **成果物**: `src/routes/api/themes/[id]/+server.ts` (GET)
  - **並列可能**: フロントエンド 1.3（テーマ詳細ページ）

- [ ] **1.4 PATCH /api/themes/[id] - テーマ更新**
  - 部分更新対応
  - ユーザースコープ検証
  - **依存**: 1.3
  - **成果物**: `src/routes/api/themes/[id]/+server.ts` (PATCH)
  - **並列可能**: フロントエンド 1.4（テーマ編集フォーム）

- [ ] **1.5 DELETE /api/themes/[id] - テーマ削除**
  - 物理削除実装（v0.1仕様）
  - カスケード削除確認（関連ログも削除される）
  - **依存**: 1.3
  - **成果物**: `src/routes/api/themes/[id]/+server.ts` (DELETE)
  - **並列可能**: フロントエンド 1.5（削除確認ダイアログ）

**セクション1完了条件**:
- [ ] 全エンドポイントが OpenAPI 仕様に準拠
- [ ] ユーザースコープ制限が全エンドポイントで機能
- [ ] エラーハンドリングが統一フォーマット

---

### セクション 2: LearningLog API（学習ログ管理）

**依存**: Theme API 完了（外部キー制約のため）

- [ ] **2.1 GET /api/logs - ログ一覧取得**
  - ユーザースコープでログ取得
  - `themeId`, `startDate`, `endDate` フィルタ対応
  - カーソルページネーション実装
  - 並び順: `date desc, created_at desc, id desc`
  - **依存**: 1.1 (Theme API)
  - **成果物**: `src/routes/api/logs/+server.ts` (GET)
  - **並列可能**: フロントエンド 2.1（ログ一覧UI）

- [ ] **2.2 POST /api/logs - ログ作成**
  - リクエストボディバリデーション
  - UUID v7 生成
  - 1日1テーマ1ログ制約チェック（P2002エラー）
  - 外部キー制約エラーハンドリング（P2003）
  - **依存**: 2.1
  - **成果物**: `src/routes/api/logs/+server.ts` (POST)
  - **並列可能**: フロントエンド 2.2（ログ作成フォーム）

- [ ] **2.3 GET /api/logs/[id] - ログ詳細取得**
  - ユーザースコープ検証
  - テーマ情報も含めて返却（Prisma include）
  - **依存**: 2.1
  - **成果物**: `src/routes/api/logs/[id]/+server.ts` (GET)
  - **並列可能**: フロントエンド 2.3（ログ詳細ページ）

- [ ] **2.4 PATCH /api/logs/[id] - ログ更新**
  - 部分更新対応
  - `date`, `themeId` 変更時の一意制約チェック
  - **依存**: 2.3
  - **成果物**: `src/routes/api/logs/[id]/+server.ts` (PATCH)
  - **並列可能**: フロントエンド 2.4（ログ編集フォーム）

- [ ] **2.5 DELETE /api/logs/[id] - ログ削除**
  - 物理削除実装
  - 関連メタノートの `relatedLogId` は NULL に設定される（ON DELETE SET NULL）
  - **依存**: 2.3
  - **成果物**: `src/routes/api/logs/[id]/+server.ts` (DELETE)
  - **並列可能**: フロントエンド 2.5（削除確認ダイアログ）

**セクション2完了条件**:
- [ ] 1日1テーマ1ログ制約が機能
- [ ] 外部キー制約エラーが適切にハンドリングされる
- [ ] 日付フィルタが正しく動作

---

### セクション 3: MetaNote API（メタノート管理）

**依存**: LearningLog API 完了（`relatedLogId` 参照のため）

**注意**: `noteDate` はサーバー側で自動生成（作成時のJST日付）

- [ ] **3.1 GET /api/notes - ノート一覧取得**
  - ユーザースコープでノート取得
  - `category`, `themeIds`, `startDate`, `endDate` フィルタ対応
  - カーソルページネーション実装
  - 並び順: `note_date desc, created_at desc, id desc`
  - **依存**: 2.1 (Log API)
  - **成果物**: `src/routes/api/notes/+server.ts` (GET)
  - **並列可能**: フロントエンド 3.1（ノート一覧UI）

- [ ] **3.2 POST /api/notes - ノート作成**
  - リクエストボディバリデーション（`noteDate` は不要）
  - UUID v7 生成
  - **サーバー側で `noteDate` を自動設定**（重要！）
  - `category` の値チェック（'気づき' | '疑問' | '感情'）
  - `themeIds` の存在確認
  - `relatedLogId` の存在確認（任意フィールド）
  - **依存**: 3.1
  - **成果物**: `src/routes/api/notes/+server.ts` (POST)
  - **並列可能**: フロントエンド 3.2（ノート作成フォーム）

- [ ] **3.3 GET /api/notes/[id] - ノート詳細取得**
  - ユーザースコープ検証
  - 関連ログ情報も含めて返却（Prisma include）
  - **依存**: 3.1
  - **成果物**: `src/routes/api/notes/[id]/+server.ts` (GET)
  - **並列可能**: フロントエンド 3.3（ノート詳細ページ）

- [ ] **3.4 PATCH /api/notes/[id] - ノート更新**
  - 部分更新対応
  - **`noteDate` は更新不可**（仕様確認）
  - `category`, `themeIds`, `relatedLogId` の検証
  - **依存**: 3.3
  - **成果物**: `src/routes/api/notes/[id]/+server.ts` (PATCH)
  - **並列可能**: フロントエンド 3.4（ノート編集フォーム）

- [ ] **3.5 DELETE /api/notes/[id] - ノート削除**
  - 物理削除実装
  - **依存**: 3.3
  - **成果物**: `src/routes/api/notes/[id]/+server.ts` (DELETE)
  - **並列可能**: フロントエンド 3.5（削除確認ダイアログ）

**セクション3完了条件**:
- [ ] `noteDate` がサーバー側で自動生成される
- [ ] `category` の値が制約に準拠
- [ ] `themeIds` 配列が正しく処理される

---

## 共通実装パターン

すべてのエンドポイントで以下のパターンを使用：

### 認証チェック（必須）

```typescript
export const GET: RequestHandler = async ({ locals }) => {
  if (!locals.user) {
    return json(
      { error: { code: 'Unauthorized', message: 'Authentication required' } },
      { status: 401 }
    );
  }
  // ...
};
```

### ユーザースコープ制限（必須）

```typescript
const items = await prisma.resource.findMany({
  where: { userId: locals.user.id }, // 必須
});
```

### UUID v7 生成（必須）

```typescript
import { uuidv7 } from 'npm:uuidv7@1';

const created = await prisma.resource.create({
  data: {
    id: uuidv7(), // 必須
    userId: locals.user.id,
    // ...
  },
});
```

### エラーハンドリング

```typescript
try {
  // ...
} catch (error) {
  // 一意制約違反
  if (error.code === 'P2002') {
    return json(
      { error: { code: 'Conflict', message: 'Resource already exists' } },
      { status: 409 }
    );
  }
  // 外部キー制約違反
  if (error.code === 'P2003') {
    return json(
      { error: { code: 'BadRequest', message: 'Referenced resource not found' } },
      { status: 400 }
    );
  }
  throw error;
}
```

---

## テスト計画

各セクション完了後、以下をテスト：

### 手動テスト（必須）

- [ ] **Theme API**: Prisma Studio または curl で CRUD 操作確認
- [ ] **Log API**: 1日1テーマ1ログ制約が機能することを確認
- [ ] **Note API**: `noteDate` が自動生成されることを確認

### 自動テスト（推奨）

- [ ] 統合テスト: 各エンドポイントの正常系・異常系
- [ ] ユーザースコープテスト: 他ユーザーのデータにアクセスできないことを確認

**参照**: `.claude/commands/test-e2e.md`

---

## 完了チェックリスト

全タスク完了後、以下を確認：

- [ ] すべてのエンドポイントが OpenAPI 仕様に準拠
- [ ] エラーレスポンスが統一フォーマット
- [ ] ユーザースコープ制限が全エンドポイントで機能
- [ ] 一意制約・外部キー制約エラーが適切にハンドリングされる
- [ ] UUID v7 が正しく生成される
- [ ] カーソルページネーションが正しく動作する

---

## フロントエンド開発との連携

### API契約の確認

フロントエンド開発チームは以下を参照：

- **OpenAPI定義**: `docs/spec/learning_log_meta_note_アプリ_技術仕様（final_v_0.md:69`
- **型定義**: `src/lib/types/index.ts`

### 並列開発時の注意点

1. **インターフェース変更時**: フロントエンドチームに通知
2. **エラーコード追加**: 統一フォーマットを維持
3. **ページネーション**: `nextCursor` の形式を変更しない

---

## トラブルシューティング

### よくある問題

**問題**: Prisma エラー `P2002` (一意制約違反)
- **解決**: 既存データとの重複を確認、適切なエラーレスポンスを返す

**問題**: `noteDate` がフロントエンドから送信される
- **解決**: リクエストボディから `noteDate` を除外、サーバー側で生成

**問題**: ユーザースコープ漏れ
- **解決**: すべてのクエリに `where: { userId: locals.user.id }` を追加

**参照**: `CLAUDE.md` の Gotchas & Pitfalls
