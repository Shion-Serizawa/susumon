# タスク計画: フロントエンド開発（Phase 1-FE）

**目的**: Svelte 5 を使用したUIコンポーネントとページの実装

**前提条件**: Phase 0（環境構築）完了

**並列実行**: バックエンド開発（Phase 1-BE）と並列実行可能

**UI仕様**: `docs/spec/learning_log_meta_note_アプリ_機能仕様（draft_v_0.md` に準拠

**重要（v0.2変更点）**:
- **MetaNote category**: DB値は英語キー（`INSIGHT`/`QUESTION`/`EMOTION`）、UI表示は日本語
- **テーマ関連**: 中間テーブル化されているが、API層では`themeIds`配列として扱う
- **削除**: 論理削除（State Machine方式）、バックエンドで自動フィルタされる
- **詳細**: `docs/spec/CHANGELOG_v0.2.md` 参照

---

## 実装規約（必須遵守）

すべてのコンポーネント実装時に以下を遵守：

### Svelte 5 必須構文

- **Props**: `let { name } = $props()` を使用（`export let` は使わない）
- **状態**: `let count = $state(0)` を使用
- **派生値**: `let doubled = $derived(count * 2)` を使用
- **副作用**: `$effect(() => { ... })` を使用
- **イベント**: `onclick={handler}` を使用（`on:click` は使わない）
- **イベント伝播**: props で `onedit`, `ondelete` などを受け取る

### TypeScript

- `src/lib/types/` から型をインポート
- `./$types` から PageData, ActionData をインポート

**参照**: `.claude/skills/sveltekit-component-builder/SKILL.md`

---

## タスク一覧

**実装順序の方針**:
1. **セクション 1-5**: Theme/Log/Note/UI を先に実装（**モック認証**を前提に進める）
2. **セクション 0**: Supabase Auth（ログイン/コールバック/ガード）は**本番デプロイ前**にまとめて対応（後回し）

**開発時の認証方針**:
- `.env` で `USE_MOCK_AUTH=true` を設定して進める（Supabase Auth は後回し）
- `USE_MOCK_AUTH=true` の間は `src/hooks.server.ts` が `locals.user` を自動設定するため、ログインUIなしで開発可能
- 参照: `docs/setup/MOCK_AUTH.md` / `docs/setup/SUPABASE_AUTH.md`

### セクション 1: Theme UI（テーマ管理画面）

**依存**: Phase 0 完了

- [x] **1.1 テーマ一覧ページ**
  - パス: `src/routes/app/themes/+page.svelte`
  - データローダー: `+page.ts` でAPI呼び出し
  - 機能:
    - テーマ一覧表示（カード形式）
    - 「達成済み」フィルタトグル
    - 無限スクロール（カーソルページネーション）
    - 新規作成ボタン
  - **依存**: Phase 0
  - **API依存**: バックエンド 1.1（GET /api/themes）
  - **成果物**: `src/routes/app/themes/+page.svelte`, `src/routes/app/themes/+page.ts`, `src/lib/mocks/themes.ts`

- [x] **1.2 テーマ作成フォーム**
  - パス: `src/routes/app/themes/new/+page.svelte`
  - フォームアクション: `+page.server.ts` で POST
  - フィールド:
    - name (必須)
    - shortName (任意)
    - goal (必須)
  - バリデーション: クライアント側 + サーバー側
  - **依存**: 1.1
  - **API依存**: バックエンド 1.2（POST /api/themes）
  - **成果物**: `src/routes/app/themes/new/+page.svelte`, `src/routes/app/themes/new/+page.server.ts`

- [x] **1.3 テーマ詳細ページ**
  - パス: `src/routes/app/themes/[id]/+page.svelte`
  - データローダー: `+page.server.ts` でAPI呼び出し
  - 表示内容:
    - テーマ基本情報
    - 達成状態
    - 関連ログ一覧（直近5件）
    - 編集・削除ボタン
  - **依存**: 1.1
  - **API依存**: バックエンド 1.3（GET /api/themes/[id]）
  - **成果物**: `src/routes/app/themes/[id]/+page.svelte`, `src/routes/app/themes/[id]/+page.server.ts`

- [x] **1.4 テーマ編集フォーム**
  - パス: `src/routes/app/themes/[id]/edit/+page.svelte`
  - フォームアクション: `+page.server.ts` で PATCH
  - フィールド: 1.2 と同様 + `isCompleted` チェックボックス
  - **依存**: 1.3
  - **API依存**: バックエンド 1.4（PATCH /api/themes/[id]）
  - **成果物**: `src/routes/app/themes/[id]/edit/+page.svelte`, `src/routes/app/themes/[id]/edit/+page.server.ts`

- [x] **1.5 テーマ削除確認ダイアログ**
  - コンポーネント: `src/lib/components/ThemeDeleteDialog.svelte`
  - 機能:
    - 削除確認メッセージ
    - 関連ログも削除される警告
    - キャンセル・削除ボタン
  - **実装注意（v0.2）**: 削除は論理削除（`state = 'DELETED'`）
  - **依存**: 1.3
  - **API依存**: バックエンド 1.5（DELETE /api/themes/[id]）
  - **成果物**: `src/lib/components/ThemeDeleteDialog.svelte`, `src/routes/app/themes/[id]/delete/+page.svelte`, `src/routes/app/themes/[id]/delete/+page.server.ts`

**セクション1完了条件**:
- [x] テーマCRUD操作が全て動作（/api/themes でスモークテスト済み）
- [x] フォームバリデーションが機能（/app/themes/new で確認済み）
- [x] エラーメッセージが適切に表示される

**修正タスク計画（コードレビュー対応）**:

🔴 **必須修正**:
1. **エラーメッセージの日本語統一**
   - `[id]/delete/+page.server.ts:27` の英語エラーメッセージを日本語化

🟡 **強く推奨**:
2. **コード重複の削減（DRY原則）**
   - `asNonEmptyString()` / `asOptionalTrimmedString()` を `src/lib/server/form-utils.ts` に移動
   - `readApiErrorMessage()` / `readApiEr()` を `src/lib/server/api-utils.ts` に移動
   - `buildThemesUrl()` を `src/lib/utils/url-builder.ts` に移動（クライアント側でも使用可能）
   - 各ファイルで共通関数をインポートして使用

3. **型定義の共有**
   - `ThemeDetail` 型を `src/lib/types/theme.ts` に統一定義
   - 各ファイルでインポートして使用

4. **サーバー側バリデーション強化**
   - `name` と `goal` の最大長チェックを追加（DB制約に合わせる）
   - Prisma schema の制約を確認して統一

🟢 **任意（後回し可）**:
5. テスト追加（ヘルパー関数のユニットテスト）
6. コンポーネント分割（`+page.svelte` の複雑性削減）
7. コメント追加（カーソルロジック等）

**参照**: CLAUDE.md **C-7 (MUST)**: 共通ライブラリを活用（DRY原則）

---

### セクション 2: LearningLog UI（学習ログ画面）

**依存**: Theme UI 完了（テーマ選択UIが必要）

- [ ] **2.1 ログ一覧ページ**
  - パス: `src/routes/app/logs/+page.svelte`
  - データローダー: `+page.ts` でAPI呼び出し
  - 機能:
    - ログ一覧表示（日付降順）
    - テーマフィルタ（ドロップダウン）
    - 日付範囲フィルタ
    - 無限スクロール
    - 新規作成ボタン
  - **依存**: Theme UI 完了
  - **API依存**: バックエンド 2.1（GET /api/logs）
  - **成果物**: `src/routes/app/logs/+page.svelte`, `+page.ts`

- [ ] **2.2 ログ作成フォーム**
  - パス: `src/routes/app/logs/new/+page.svelte`
  - フォームアクション: `+page.server.ts` で POST
  - フィールド:
    - date (日付ピッカー、デフォルト: 今日)
    - themeId (ドロップダウン、達成済みは除外)
    - summary (必須)
    - details (任意)
    - tags (配列、カンマ区切り入力)
  - バリデーション:
    - 1日1テーマ1ログ制約エラーハンドリング
  - **依存**: 2.1
  - **API依存**: バックエンド 2.2（POST /api/logs）
  - **成果物**: `src/routes/app/logs/new/+page.svelte`, `+page.server.ts`

- [ ] **2.3 ログ詳細ページ**
  - パス: `src/routes/app/logs/[id]/+page.svelte`
  - データローダー: `+page.server.ts` でAPI呼び出し
  - 表示内容:
    - ログ基本情報
    - テーマ情報（リンク付き）
    - タグ一覧
    - 関連メタノート一覧
    - 編集・削除ボタン
    - 「このログからメタノート作成」ボタン
  - **依存**: 2.1
  - **API依存**: バックエンド 2.3（GET /api/logs/[id]）
  - **成果物**: `src/routes/app/logs/[id]/+page.svelte`, `+page.server.ts`

- [ ] **2.4 ログ編集フォーム**
  - パス: `src/routes/app/logs/[id]/edit/+page.svelte`
  - フォームアクション: `+page.server.ts` で PATCH
  - フィールド: 2.2 と同様
  - **依存**: 2.3
  - **API依存**: バックエンド 2.4（PATCH /api/logs/[id]）
  - **成果物**: `src/routes/app/logs/[id]/edit/+page.svelte`, `+page.server.ts`

- [ ] **2.5 ログ削除確認ダイアログ**
  - コンポーネント: `src/lib/components/LogDeleteDialog.svelte`
  - 機能:
    - 削除確認メッセージ
    - 関連メタノートの `relatedLogId` が NULL になる警告
    - キャンセル・削除ボタン
  - **実装注意（v0.2）**: 削除は論理削除（`state = 'DELETED'`）
  - **依存**: 2.3
  - **API依存**: バックエンド 2.5（DELETE /api/logs/[id]）
  - **成果物**: `src/lib/components/LogDeleteDialog.svelte`

**セクション2完了条件**:
- [ ] ログCRUD操作が全て動作
- [ ] 日付フィルタが正しく機能
- [ ] テーマフィルタが正しく機能

---

### セクション 3: MetaNote UI（メタノート画面）

**依存**: LearningLog UI 完了（ログ詳細から作成可能にするため）

**重要（v0.2）**:
- `noteDate` はサーバー側で自動生成されるため、フォームに日付入力フィールドは不要
- `category` はDB値が英語キー（`INSIGHT`/`QUESTION`/`EMOTION`）、UI表示は日本語（気づき/疑問/感情）
- テーマは中間テーブル（`meta_note_themes`）で管理されるが、API層で`themeIds`配列として扱う

**カテゴリ表示マッピング**:
```typescript
const CATEGORY_LABELS: Record<string, string> = {
  INSIGHT: '気づき',
  QUESTION: '疑問',
  EMOTION: '感情'
};
```

- [ ] **3.1 ノート一覧ページ**
  - パス: `src/routes/app/notes/+page.svelte`
  - データローダー: `+page.ts` でAPI呼び出し
  - 機能:
    - ノート一覧表示（noteDate 降順）
    - カテゴリフィルタ（気づき/疑問/感情）
      - **実装注意**: APIには英語キー（`INSIGHT`/`QUESTION`/`EMOTION`）を送信
    - テーマフィルタ（複数選択可）
    - 日付範囲フィルタ
    - 無限スクロール
    - 新規作成ボタン
  - **依存**: LearningLog UI 完了
  - **API依存**: バックエンド 3.1（GET /api/notes）
  - **成果物**: `src/routes/app/notes/+page.svelte`, `+page.ts`

- [ ] **3.2 ノート作成フォーム**
  - パス: `src/routes/app/notes/new/+page.svelte`
  - フォームアクション: `+page.server.ts` で POST
  - フィールド:
    - category (ラジオボタン: 気づき/疑問/感情)
      - **実装注意**: 表示は日本語、送信値は英語キー（`INSIGHT`/`QUESTION`/`EMOTION`）
    - body (必須、テキストエリア)
    - themeIds (チェックボックス、達成済みもトグルで選択可)
      - **実装注意**: APIには配列形式で送信（バックエンド側で中間テーブルに変換）
    - relatedLogId (任意、URL パラメータから自動設定可能)
  - **noteDate はフォームに含めない**（サーバー側で自動生成）
  - **依存**: 3.1
  - **API依存**: バックエンド 3.2（POST /api/notes）
  - **成果物**: `src/routes/app/notes/new/+page.svelte`, `+page.server.ts`

- [ ] **3.3 ノート詳細ページ**
  - パス: `src/routes/app/notes/[id]/+page.svelte`
  - データローダー: `+page.server.ts` でAPI呼び出し
  - 表示内容:
    - ノート基本情報
    - カテゴリ（アイコン付き）
      - **実装注意**: APIレスポンスの英語キーを日本語表示に変換
    - noteDate（自動生成された日付）
    - 関連テーマ一覧（リンク付き）
      - **実装注意**: APIレスポンスは`themes`配列または`themeIds`配列
    - 関連ログ（あれば、リンク付き）
    - 編集・削除ボタン
  - **依存**: 3.1
  - **API依存**: バックエンド 3.3（GET /api/notes/[id]）
  - **成果物**: `src/routes/app/notes/[id]/+page.svelte`, `+page.server.ts`

- [ ] **3.4 ノート編集フォーム**
  - パス: `src/routes/app/notes/[id]/edit/+page.svelte`
  - フォームアクション: `+page.server.ts` で PATCH
  - フィールド: 3.2 と同様
    - **実装注意**: categoryの表示/送信値変換に注意
  - **noteDate は表示のみ（編集不可）**
  - **依存**: 3.3
  - **API依存**: バックエンド 3.4（PATCH /api/notes/[id]）
  - **成果物**: `src/routes/app/notes/[id]/edit/+page.svelte`, `+page.server.ts`

- [ ] **3.5 ノート削除確認ダイアログ**
  - コンポーネント: `src/lib/components/NoteDeleteDialog.svelte`
  - 機能:
    - 削除確認メッセージ
    - キャンセル・削除ボタン
  - **実装注意（v0.2）**: 削除は論理削除（`state = 'DELETED'`）
  - **依存**: 3.3
  - **API依存**: バックエンド 3.5（DELETE /api/notes/[id]）
  - **成果物**: `src/lib/components/NoteDeleteDialog.svelte`

**セクション3完了条件**:
- [ ] ノートCRUD操作が全て動作
- [ ] カテゴリフィルタが機能
  - [ ] UI表示は日本語（気づき/疑問/感情）
  - [ ] APIリクエストは英語キー（INSIGHT/QUESTION/EMOTION）
- [ ] テーマ複数選択が正しく動作
  - [ ] `themeIds`配列形式でAPIに送信できる
- [ ] `noteDate` が自動生成されることを確認

---

### セクション 4: 共通コンポーネント

**依存**: なし（並列実行可能）

- [ ] **4.1 ナビゲーションヘッダー**
  - コンポーネント: `src/lib/components/Navigation.svelte`
  - 機能:
    - ロゴ
    - メニューリンク（テーマ/ログ/ノート）
    - ユーザー情報表示（モック）
  - **依存**: なし
  - **成果物**: `src/lib/components/Navigation.svelte`

- [ ] **4.2 ページネーションコンポーネント**
  - コンポーネント: `src/lib/components/Pagination.svelte`
  - 機能:
    - 「もっと読み込む」ボタン
    - ローディングスピナー
    - カーソルページネーション対応
  - **依存**: なし
  - **成果物**: `src/lib/components/Pagination.svelte`

- [ ] **4.3 エラー表示コンポーネント**
  - コンポーネント: `src/lib/components/ErrorMessage.svelte`
  - 機能:
    - エラーメッセージ表示
    - エラーコード表示
    - 閉じるボタン
  - **依存**: なし
  - **成果物**: `src/lib/components/ErrorMessage.svelte`

- [ ] **4.4 ローディングスピナー**
  - コンポーネント: `src/lib/components/LoadingSpinner.svelte`
  - 機能: シンプルなスピナーアニメーション
  - **依存**: なし
  - **成果物**: `src/lib/components/LoadingSpinner.svelte`

- [ ] **4.5 日付フィルタコンポーネント**
  - コンポーネント: `src/lib/components/DateRangeFilter.svelte`
  - 機能:
    - 開始日・終了日入力
    - クリアボタン
  - **依存**: なし
  - **成果物**: `src/lib/components/DateRangeFilter.svelte`

**セクション4完了条件**:
- [ ] すべての共通コンポーネントが Svelte 5 構文で実装されている
- [ ] 型安全性が確保されている

---

### セクション 5: レイアウト・ルーティング

**依存**: 共通コンポーネント完了

- [ ] **5.1 ルートレイアウト**
  - パス: `src/routes/+layout.svelte`
  - 機能:
    - HTMLベース構造
    - グローバルスタイル読み込み
  - **依存**: なし
  - **成果物**: `src/routes/+layout.svelte`

- [ ] **5.2 アプリレイアウト**
  - パス: `src/routes/app/+layout.svelte`
  - 機能:
    - ナビゲーションヘッダー表示
  - **依存**: 4.1（Navigation）
  - **成果物**: `src/routes/app/+layout.svelte`

- [ ] **5.3 トップページ**
  - パス: `src/routes/app/+page.svelte`
  - 機能:
    - ダッシュボード（後のフェーズで実装）
    - 現在は各セクションへのリンク表示
  - **依存**: 5.2
  - **成果物**: `src/routes/app/+page.svelte`

**セクション5完了条件**:
- [ ] すべてのページで共通レイアウトが適用される

---

### セクション 0: 認証（後回し / 本番デプロイ前）

**目的**: Supabase Auth 導入時に必要なUI/ルーティング/ガードをまとめて実装する

**依存**: セクション 5 完了（ルーティング・レイアウト整備後）

- [ ] **0.1 ログインページ**
  - パス: `src/routes/(auth)/login/+page.svelte`（ルートは `/login`）
  - `USE_MOCK_AUTH=true` の開発中は「未実装」表示でOK（本実装時に更新）
  - **成果物**: `src/routes/(auth)/login/+page.svelte`

- [ ] **0.1.1 OAuth コールバック（方針決定 + 実装）**
  - パス案: `src/routes/(auth)/auth/callback/+page.server.ts`（または `+server.ts`、ルートは `/auth/callback`）
  - Supabase の OAuth / PKCE をどこで完結させるか（サーバー側 or クライアント側）を決める
  - **成果物**: `src/routes/(auth)/auth/callback/*`（方針により変動）

- [ ] **0.2 認証ガード（`(app)` 配下の保護）**
  - パス: `src/routes/app/+layout.server.ts`
  - `locals.user` が null の場合は `/login` へリダイレクト（`USE_MOCK_AUTH=true` の間は常に認証済み扱い）
  - **成果物**: `src/routes/app/+layout.server.ts`

**参照**: `docs/setup/SUPABASE_AUTH.md`

---

## Svelte 5 実装パターン

### コンポーネントprops

```svelte
<script lang="ts">
  import type { Theme } from '$lib/types';

  let { theme, readonly = false, onedit, ondelete }: {
    theme: Theme;
    readonly?: boolean;
    onedit?: (id: string) => void;
    ondelete?: (id: string) => void;
  } = $props();
</script>
```

### 状態管理

```svelte
<script lang="ts">
  // リアクティブな状態
  let count = $state(0);

  // 派生値
  let doubled = $derived(count * 2);

  // 副作用
  $effect(() => {
    console.log(`Count: ${count}`);
  });
</script>
```

### イベントハンドラ

```svelte
<button onclick={handleClick}>Click</button>
<input onchange={handleChange} />
```

### フォームenhance

```svelte
<script lang="ts">
  import { enhance } from '$app/forms';

  let name = $state('');
  let errors = $state<Record<string, string>>({});
</script>

<form method="POST" use:enhance>
  <input name="name" bind:value={name} />
  {#if errors.name}
    <span class="error">{errors.name}</span>
  {/if}
</form>
```

**参照**: `.claude/skills/sveltekit-component-builder/SKILL.md`

---

## バックエンド開発との連携

### API呼び出しパターン

```typescript
// +page.ts (クライアント側)
export const load: PageLoad = async ({ fetch }) => {
  const response = await fetch('/api/themes');
  const data = await response.json();

  if (!response.ok) {
    throw error(response.status, data.error.message);
  }

  return { themes: data.items };
};
```

```typescript
// +page.server.ts (サーバー側)
export const actions: Actions = {
  default: async ({ request, locals, fetch }) => {
    const formData = await request.formData();

    const response = await fetch('/api/themes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: formData.get('name'),
        goal: formData.get('goal'),
      }),
    });

    if (!response.ok) {
      const error = await response.json();
      return fail(response.status, { error: error.error.message });
    }

    return { success: true };
  },
};
```

### v0.2 固有の注意事項

#### MetaNote のカテゴリ処理

```typescript
// フォームからの送信値変換（日本語 → 英語キー）
const categoryMap: Record<string, string> = {
  '気づき': 'INSIGHT',
  '疑問': 'QUESTION',
  '感情': 'EMOTION'
};

// APIレスポンスの表示変換（英語キー → 日本語）
const CATEGORY_LABELS: Record<string, string> = {
  INSIGHT: '気づき',
  QUESTION: '疑問',
  EMOTION: '感情'
};
```

#### テーマ複数選択の処理

```typescript
// フォームから配列を収集
const themeIds = formData.getAll('themeIds'); // string[]

// APIリクエスト
body: JSON.stringify({
  category: 'INSIGHT',
  body: formData.get('body'),
  themeIds: themeIds, // 配列形式で送信
  relatedLogId: formData.get('relatedLogId') || null
})
```

### 並列開発時の注意点

1. **モックデータ**: バックエンドAPI未完成時は、+page.ts でモックデータを返す
2. **型定義優先**: `src/lib/types/` の型を先に確定
   - **重要**: `MetaNoteCategory` は `'INSIGHT' | 'QUESTION' | 'EMOTION'` 型
3. **エラーハンドリング**: API エラーレスポンスの形式を事前確認
4. **v0.2変更**: categoryは英語キー、themeIdsは配列形式

---

## テスト計画

### 手動テスト（必須）

- [ ] **Theme UI**: 全CRUD操作が正しく動作
- [ ] **Log UI**: フィルタが正しく機能
- [ ] **Note UI**: カテゴリ・テーマ複数選択が正しく動作
- [ ] **レスポンシブ**: モバイル・タブレット・デスクトップで表示確認

### 自動テスト（推奨）

- [ ] E2Eテスト: 主要ユーザーフロー（テーマ作成→ログ作成→ノート作成）

**参照**: `.claude/commands/test-e2e.md`

---

## 完了チェックリスト

全タスク完了後、以下を確認：

- [ ] すべてのページが Svelte 5 構文で実装されている
- [ ] TypeScript 型エラーがない
- [ ] フォームバリデーションが機能している
- [ ] エラーメッセージが適切に表示される
- [ ] ページネーションが正しく動作する
- [ ] モバイル対応ができている

---

## トラブルシューティング

### よくある問題

**問題**: `export let` 構文でエラー
- **解決**: `let { prop } = $props()` に変更

**問題**: `on:click` が動作しない
- **解決**: `onclick` に変更

**問題**: リアクティビティが動作しない
- **解決**: `$state()` を使用

**問題（v0.2）**: MetaNoteのcategoryが保存されない
- **原因**: DB値は英語キー（`INSIGHT`/`QUESTION`/`EMOTION`）
- **解決**: フォーム送信時に日本語→英語キーに変換する

**問題（v0.2）**: themeIdsが保存されない
- **原因**: 配列形式で送信する必要がある
- **解決**: `formData.getAll('themeIds')` で配列を取得してAPI送信

**問題（v0.2）**: 削除したデータが表示される
- **原因**: 論理削除なので `state = 'DELETED'` のレコードが残っている
- **解決**: バックエンドのPrisma Client Extensionsが自動フィルタするため、通常は表示されない

**参照**: `.claude/skills/sveltekit-component-builder/SKILL.md` の Key Gotchas
