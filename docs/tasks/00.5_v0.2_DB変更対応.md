# ã‚¿ã‚¹ã‚¯è¨ˆç”»: v0.2 DBå¤‰æ›´å¯¾å¿œï¼ˆPhase 0.5ï¼‰

**ç›®çš„**: v0.1ã‹ã‚‰v0.2ã®DBè¨­è¨ˆå¤‰æ›´ã«å¯¾å¿œã—ãŸã‚³ãƒ¼ãƒ‰ä¿®æ­£

**å‰ææ¡ä»¶**:
- Phase 0ï¼ˆç’°å¢ƒæ§‹ç¯‰ï¼‰å®Œäº†
- Prismaã‚¹ã‚­ãƒ¼ãƒãŒv0.2ã«æ›´æ–°æ¸ˆã¿
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰ç¢ºèªæ¸ˆã¿ï¼ˆ`docs/setup/MIGRATION_v0.1_to_v0.2.md`ï¼‰

**å„ªå…ˆåº¦**: ğŸ”´ **é«˜**ï¼ˆPhase 1-BEé–‹å§‹å‰ã«å®Œäº†å¿…é ˆï¼‰

**å¤‰æ›´ãƒ­ã‚°**: `docs/spec/CHANGELOG_v0.2.md`

---

## v0.2ã®ä¸»ãªå¤‰æ›´ç‚¹

### 1. **State Machineæ–¹å¼ã®è«–ç†å‰Šé™¤**
- `deletedAt: DateTime?` â†’ `state: ResourceState` + `stateChangedAt: DateTime`
- çŠ¶æ…‹: ACTIVE / ARCHIVED / DELETED
- Prisma Client Extensionsã§è‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿å®Ÿè£…æ¸ˆã¿

### 2. **categoryå€¤ã®è‹±èªåŒ–**
- DBå€¤: `'æ°—ã¥ã'` â†’ `'INSIGHT'`
- UIè¡¨ç¤ºã¯`CATEGORY_LABELS`ã§å¤šè¨€èªå¯¾å¿œ

### 3. **ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«åŒ–**
- `themeIds: String[]` â†’ `MetaNoteTheme`ãƒ†ãƒ¼ãƒ–ãƒ«
- å‚ç…§æ•´åˆæ€§ã‚’DBåˆ¶ç´„ã§ä¿è¨¼

### 4. **UUIDv7ã®DBå´æ¡ç•ª**
- `@default(dbgenerated("uuid_v7()"))`
- PostgreSQL 17å¿…é ˆ

---

## ã‚¿ã‚¹ã‚¯ä¸€è¦§

### âœ… å®Œäº†æ¸ˆã¿

- [x] **0.5.1 Prismaã‚¹ã‚­ãƒ¼ãƒæ›´æ–°**
  - State Machineæ–¹å¼ã¸ã®å¤‰æ›´
  - categoryè‹±èªåŒ–
  - ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
  - UUIDv7ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
  - **æˆæœç‰©**: `prisma/schema.prisma`

- [x] **0.5.2 Prisma Client Extensionså®Ÿè£…**
  - `userId`ã‚¹ã‚³ãƒ¼ãƒ—å¼·åˆ¶ãƒã‚§ãƒƒã‚¯
  - `state != 'DELETED'`è‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿
  - **æˆæœç‰©**: `src/lib/server/db.ts`

- [x] **0.5.3 å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°**
  - `ResourceState`å‹
  - `MetaNoteCategory`å‹
  - `MetaNoteWithThemes`å‹
  - **æˆæœç‰©**: `src/lib/types/index.ts`

- [x] **0.5.4 Dockeræ§‹æˆæ›´æ–°**
  - PostgreSQL 17-alpine
  - **æˆæœç‰©**: `docker-compose.yml`

- [x] **0.5.5 ä»•æ§˜æ›¸æ›´æ–°**
  - DBè¨­è¨ˆæ›¸v0.2
  - CHANGELOG_v0.2.md
  - CLAUDE.mdæ›´æ–°
  - **æˆæœç‰©**: `docs/spec/*`

- [x] **0.5.6 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰ä½œæˆ**
  - v0.1â†’v0.2ç§»è¡Œæ‰‹é †
  - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †
  - **æˆæœç‰©**: `docs/setup/MIGRATION_v0.1_to_v0.2.md`

---

### ğŸ”„ å®Ÿæ–½æ¨å¥¨ï¼ˆAPIå®Ÿè£…å‰ï¼‰

- [ ] **0.5.7 Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**
  ```bash
  # æ–°è¦DBã®å ´åˆ
  docker compose down -v
  docker compose up -d postgres
  deno task db:migrate:dev --name v0.2_state_machine_and_normalization
  deno task db:generate

  # æ—¢å­˜DBã®å ´åˆ
  # docs/setup/MIGRATION_v0.1_to_v0.2.md ã‚’å‚ç…§
  ```
  - **æˆæœç‰©**: `prisma/migrations/*/migration.sql`
  - **æ¤œè¨¼**: DBæ¥ç¶šã€ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã€uuid_v7()å‹•ä½œç¢ºèª

- [ ] **0.5.8 å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯**
  ```bash
  # å‹ãƒã‚§ãƒƒã‚¯
  deno task typecheck

  # Prisma Clientç”Ÿæˆç¢ºèª
  deno task db:generate

  # é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ç¢ºèª
  deno task dev
  ```

---

### âš ï¸ APIå®Ÿè£…æ™‚ã®æ³¨æ„äº‹é …

#### ãƒ†ãƒ¼ãƒAPI (`/api/themes/*`)

**v0.1ã‹ã‚‰ã®å¤‰æ›´ãªã—** - ãŸã ã—ä»¥ä¸‹ã«æ³¨æ„ï¼š
- `deleted_at`ã¯ä½¿ç”¨ä¸å¯ï¼ˆ`state`ã‚’ä½¿ç”¨ï¼‰
- å‰Šé™¤ã¯`UPDATE SET state = 'DELETED'`ã§å®Ÿè£…
- UUIDv7ã¯DBå´ã§è‡ªå‹•ç”Ÿæˆï¼ˆã‚¢ãƒ—ãƒªå´ç”Ÿæˆä¸è¦ï¼‰

```typescript
// Good (v0.2)
await prisma.theme.update({
  where: { id },
  data: { state: 'DELETED', stateChangedAt: new Date() }
});

// Bad (v0.1)
await prisma.theme.update({
  where: { id },
  data: { deletedAt: new Date() }
});
```

#### ãƒ­ã‚°API (`/api/logs/*`)

**v0.1ã‹ã‚‰ã®å¤‰æ›´ãªã—** - stateç®¡ç†ã®ã¿è¿½åŠ 

#### ãƒ¡ã‚¿ãƒãƒ¼ãƒˆAPI (`/api/notes/*`)

**âš ï¸ é‡å¤§ãªå¤‰æ›´ã‚ã‚Š**

##### 1. categoryå€¤ã®å¤‰æ›´

```typescript
// Good (v0.2)
const category: MetaNoteCategory = 'INSIGHT'; // è‹±èªã‚­ãƒ¼

// UIè¡¨ç¤º
import { getCategoryLabel } from '$lib/types';
const label = getCategoryLabel(category); // 'æ°—ã¥ã'

// Bad (v0.1)
const category = 'æ°—ã¥ã'; // æ—¥æœ¬èªå€¤ã¯ä½¿ç”¨ä¸å¯
```

##### 2. themeIds â†’ ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«

**ä½œæˆæ™‚:**
```typescript
// Good (v0.2)
const note = await prisma.metaNote.create({
  data: {
    userId: locals.user.id,
    category: 'INSIGHT',
    body: '...',
    noteDate: new Date(),
    metaNoteThemes: {
      create: themeIds.map(themeId => ({
        themeId,
        createdAt: new Date()
      }))
    }
  }
});

// Bad (v0.1)
await prisma.metaNote.create({
  data: {
    themeIds: ['theme-1', 'theme-2'] // é…åˆ—ã¯ä½¿ç”¨ä¸å¯
  }
});
```

**æ›´æ–°æ™‚:**
```typescript
// Good (v0.2)
await prisma.$transaction(async (tx) => {
  // æ—¢å­˜ã®é–¢é€£ã‚’å‰Šé™¤
  await tx.metaNoteTheme.deleteMany({
    where: { metaNoteId: noteId }
  });

  // æ–°ã—ã„é–¢é€£ã‚’ä½œæˆ
  if (themeIds.length > 0) {
    await tx.metaNoteTheme.createMany({
      data: themeIds.map(themeId => ({
        metaNoteId: noteId,
        themeId
      }))
    });
  }

  // ãƒ¡ã‚¿ãƒãƒ¼ãƒˆæœ¬ä½“ã‚’æ›´æ–°
  return tx.metaNote.update({
    where: { id: noteId },
    data: { body, category }
  });
});
```

**å–å¾—æ™‚:**
```typescript
// Good (v0.2) - é–¢é€£ãƒ†ãƒ¼ãƒã‚’å«ã‚ã‚‹
const note = await prisma.metaNote.findUnique({
  where: { id },
  include: {
    metaNoteThemes: {
      include: {
        theme: {
          select: { id: true, name: true }
        }
      }
    }
  }
});

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢
const response = {
  ...note,
  themes: note.metaNoteThemes.map(mnt => mnt.theme),
  metaNoteThemes: undefined // å†…éƒ¨æ§‹é€ ã¯é™¤å¤–
};
```

---

## ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–

### categoryå€¤ã®æ¤œè¨¼

```typescript
import { isValidCategory } from '$lib/types';

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£æ¤œè¨¼
if (!isValidCategory(body.category)) {
  return json(
    { error: { code: 'InvalidCategory', message: 'Invalid category value' } },
    { status: 400 }
  );
}
```

### themeIdså‚ç…§æ•´åˆæ€§æ¤œè¨¼

```typescript
// themeIdsãŒã™ã¹ã¦å­˜åœ¨ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
const validThemes = await prisma.theme.findMany({
  where: {
    id: { in: themeIds },
    userId: locals.user.id
  },
  select: { id: true }
});

if (validThemes.length !== themeIds.length) {
  return json(
    { error: { code: 'InvalidThemeIds', message: 'Some theme IDs do not exist' } },
    { status: 400 }
  );
}
```

---

## ãƒ†ã‚¹ãƒˆæ›´æ–°

### æ—¢å­˜ãƒ†ã‚¹ãƒˆã®ä¿®æ­£ç®‡æ‰€

1. **categoryå€¤**: `'æ°—ã¥ã'` â†’ `'INSIGHT'`
2. **themeIds**: é…åˆ— â†’ ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã®include
3. **deleted_at**: stateç¢ºèªã«å¤‰æ›´
4. **UUIDç”Ÿæˆ**: ã‚¢ãƒ—ãƒªå´ç”Ÿæˆå‰Šé™¤

---

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] Prismaã‚¹ã‚­ãƒ¼ãƒæ›´æ–°
- [x] Prisma Client Extensionså®Ÿè£…
- [x] å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°
- [x] Dockeræ§‹æˆæ›´æ–°
- [x] ä»•æ§˜æ›¸æ›´æ–°
- [x] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰ä½œæˆ
- [ ] Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
- [ ] APIå®Ÿè£…æ›´æ–°ï¼ˆPhase 1-BEï¼‰
- [ ] ãƒ†ã‚¹ãƒˆæ›´æ–°ï¼ˆPhase 1-BEï¼‰
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ›´æ–°ï¼ˆPhase 1-FEï¼‰

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… **Phase 0.5å®Œäº†å¾Œ** â†’ Phase 1-BEï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºï¼‰ã¸
2. âš ï¸ **APIå®Ÿè£…æ™‚** â†’ æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ³¨æ„äº‹é …ã‚’å‚ç…§
3. ğŸ“– **è©³ç´°ä»•æ§˜** â†’ `docs/spec/CHANGELOG_v0.2.md`

---

ä»¥ä¸Šã§v0.2 DBå¤‰æ›´å¯¾å¿œãŒå®Œäº†ã§ã™ã€‚
