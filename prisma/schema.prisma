// Prisma schema for Learning Log / Meta Note App
// Runtime: Deno Deploy
// Database: Deno Deploy Prisma Postgres

generator client {
  provider = "prisma-client-js"
  output   = "../.prisma/client"
  // v7 uses 'client' engine with adapter (required for Deno Deploy)
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

// ===== Tables =====

// Resource state for soft delete with state machine
enum ResourceState {
  ACTIVE
  ARCHIVED
  DELETED
}

model Theme {
  id               String        @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  userId           String        @map("user_id") @db.Uuid // Supabase auth.users.id
  name             String
  shortName        String?       @map("short_name")
  goal             String
  isCompleted      Boolean       @default(false) @map("is_completed")
  state            ResourceState @default(ACTIVE)
  stateChangedAt   DateTime      @default(now()) @map("state_changed_at") @db.Timestamptz
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  logs             LearningLogEntry[]
  metaNoteThemes   MetaNoteTheme[]

  // Indexes
  @@index([userId, isCompleted], name: "idx_themes_user_completed")
  @@index([userId, state], name: "idx_themes_user_state")

  @@map("themes")
}

model LearningLogEntry {
  id             String        @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  userId         String        @map("user_id") @db.Uuid // Supabase auth.users.id
  themeId        String        @map("theme_id") @db.Uuid
  date           DateTime      @db.Date
  summary        String
  details        String?
  tags           String[]      @default([])
  state          ResourceState @default(ACTIVE)
  stateChangedAt DateTime      @default(now()) @map("state_changed_at") @db.Timestamptz
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  theme          Theme         @relation(fields: [themeId], references: [id], onDelete: Cascade)
  metaNotes      MetaNote[]

  // Constraints
  @@unique([userId, themeId, date], name: "uq_log_per_day")

  // Indexes
  @@index([userId, date], name: "idx_logs_user_date")
  @@index([userId, themeId, date], name: "idx_logs_user_theme_date")
  @@index([userId, state], name: "idx_logs_user_state")
  @@index([tags], type: Gin, name: "gin_logs_tags")

  @@map("learning_log_entries")
}

model MetaNote {
  id             String            @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  userId         String            @map("user_id") @db.Uuid // Supabase auth.users.id
  category       String            // 'INSIGHT', 'QUESTION', 'EMOTION'
  body           String
  relatedLogId   String?           @map("related_log_id") @db.Uuid
  noteDate       DateTime          @map("note_date") @db.Date
  state          ResourceState     @default(ACTIVE)
  stateChangedAt DateTime          @default(now()) @map("state_changed_at") @db.Timestamptz
  createdAt      DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  relatedLog     LearningLogEntry? @relation(fields: [relatedLogId], references: [id], onDelete: SetNull)
  metaNoteThemes MetaNoteTheme[]

  // Indexes
  @@index([userId, noteDate], name: "idx_notes_user_date")
  @@index([userId, category, noteDate], name: "idx_notes_user_category_date")
  @@index([userId, state], name: "idx_notes_user_state")

  @@map("meta_notes")
}

// Note: CHECK constraint for category will be added manually in migration SQL
// ALTER TABLE meta_notes ADD CONSTRAINT chk_meta_category CHECK (category IN ('INSIGHT', 'QUESTION', 'EMOTION'))

// Junction table for MetaNote <-> Theme many-to-many relationship
model MetaNoteTheme {
  metaNoteId String   @map("meta_note_id") @db.Uuid
  themeId    String   @map("theme_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  metaNote MetaNote @relation(fields: [metaNoteId], references: [id], onDelete: Cascade)
  theme    Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)

  // Constraints
  @@id([metaNoteId, themeId])
  @@index([themeId], name: "idx_meta_note_themes_theme_id")

  @@map("meta_note_themes")
}
