// Prisma schema for Learning Log / Meta Note App
// Runtime: Deno Deploy
// Database: Deno Deploy Prisma Postgres

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
  runtime  = "deno" // REQUIRED for Deno Deploy + Prisma 7
}

datasource db {
  provider = "postgresql"
}

// ===== Tables =====

enum MetaNoteCategory {
  KIZUKI @map("気づき")
  GIMON  @map("疑問")
  KANJO  @map("感情")
}

model Theme {
  id          String   @id // UUIDv7 (generated by app)
  userId      String   @map("user_id") // Supabase auth.users.id (uuid)
  name        String
  shortName   String?  @map("short_name")
  goal        String
  isCompleted Boolean  @default(false) @map("is_completed")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  logs LearningLogEntry[]

  // Indexes
  @@index([userId, isCompleted], name: "idx_themes_user_completed")

  @@map("themes")
}

model LearningLogEntry {
  id        String    @id // UUIDv7 (generated by app)
  userId    String    @map("user_id") // Supabase auth.users.id (uuid)
  themeId   String    @map("theme_id")
  date      DateTime  @db.Date
  summary   String
  details   String?
  tags      String[]  @default([])
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  theme     Theme     @relation(fields: [themeId], references: [id], onDelete: Cascade)
  metaNotes MetaNote[]

  // Constraints
  @@unique([userId, themeId, date], name: "uq_log_per_day")

  // Indexes
  @@index([userId, date], name: "idx_logs_user_date")
  @@index([userId, themeId, date], name: "idx_logs_user_theme_date")
  @@index([tags], type: Gin, name: "gin_logs_tags")

  @@map("learning_log_entries")
}

model MetaNote {
  id           String    @id // UUIDv7 (generated by app)
  userId       String    @map("user_id") // Supabase auth.users.id (uuid)
  category     MetaNoteCategory // Enforced by DB enum
  body         String
  themeIds     String[]  @default([]) @map("theme_ids")
  relatedLogId String?   @map("related_log_id")
  noteDate     DateTime  @map("note_date") @db.Date
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  relatedLog LearningLogEntry? @relation(fields: [relatedLogId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([userId, noteDate], name: "idx_notes_user_date")
  @@index([userId, category, noteDate], name: "idx_notes_user_category_date")
  @@index([themeIds], type: Gin, name: "gin_notes_theme_ids")

  @@map("meta_notes")
}
