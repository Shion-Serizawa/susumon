---
name: prisma-schema-manager
description: Create and manage Prisma schema, migrations, and models for PostgreSQL on Deno Deploy. Use when working with database schema design or migrations.
allowed-tools: [Read, Write, Edit, Bash]
---

# Prisma Schema Manager Skill

## When to Activate
- User asks to create database schema
- User mentions "migration", "Prisma model", or "database table"
- User wants to update existing schema

## Process

### 1. Review DB Design Spec
- Read: `docs/spec/learning_log_meta_note_アプリ_db設計（draft_v_0.md`
- Confirm table structure, constraints, indexes

### 2. Update Prisma Schema

**Location**: `prisma/schema.prisma`

**Template** (Prisma 7 + Deno Deploy):
```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
  runtime  = "deno"  // Deno ランタイムを明示（必須！）
}

model Theme {
  id          String   @id @default(uuid()) // UUIDv7 generated by app
  userId      String   @map("user_id")

  name        String
  shortName   String?  @map("short_name")
  goal        String
  isCompleted Boolean  @default(false) @map("is_completed")

  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz // v0.1 では未使用

  learningLogs LearningLogEntry[]

  @@index([userId, isCompleted], name: "idx_themes_user_completed")
  @@map("themes")
}

model LearningLogEntry {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  themeId   String   @map("theme_id")
  date      DateTime @db.Date

  summary   String
  details   String?
  tags      String[] @default([])

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz

  theme     Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)
  metaNotes MetaNote[]

  @@unique([userId, themeId, date], name: "uq_log_per_day")
  @@index([userId, date], name: "idx_logs_user_date")
  @@index([userId, themeId, date], name: "idx_logs_user_theme_date")
  @@map("learning_log_entries")
}

model MetaNote {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  category      String    // CHECK constraint: '気づき' | '疑問' | '感情'
  body          String
  themeIds      String[]  @default([]) @map("theme_ids")
  relatedLogId  String?   @map("related_log_id")
  noteDate      DateTime  @map("note_date") @db.Date

  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  relatedLog    LearningLogEntry? @relation(fields: [relatedLogId], references: [id], onDelete: SetNull)

  @@index([userId, noteDate], name: "idx_notes_user_date")
  @@index([userId, category, noteDate], name: "idx_notes_user_category_date")
  @@map("meta_notes")
}
```

### 3. Create Migration

```bash
# Development environment
deno task db:migrate:dev --name add_initial_tables

# This will:
# 1. Generate SQL migration file in prisma/migrations/
# 2. Apply migration to database
# 3. Regenerate Prisma Client
```

### 4. Manual Migration Adjustments

After generating migration, add CHECK constraints manually:

**Example** (`prisma/migrations/XXXXXX_add_initial_tables/migration.sql`):
```sql
-- Add CHECK constraint for MetaNote.category
ALTER TABLE meta_notes
  ADD CONSTRAINT chk_meta_category
  CHECK (category IN ('気づき', '疑問', '感情'));

-- Add GIN indexes for array columns
CREATE INDEX IF NOT EXISTS gin_logs_tags
  ON learning_log_entries USING gin (tags);

CREATE INDEX IF NOT EXISTS gin_notes_theme_ids
  ON meta_notes USING gin (theme_ids);
```

### 5. Apply Migration

```bash
# Production/Staging (Deno Deploy)
deno task db:migrate:deploy

# Verify schema
deno task db:studio
```

## Critical Checks

✅ **MUST**:
- [ ] `runtime = "deno"` in generator (Prisma 7+ 必須)
- [ ] `@map()` でスネークケース→キャメルケース変換
- [ ] `userId` は必須（全モデル）
- [ ] `@db.Date` for JST local dates (date, noteDate)
- [ ] `@db.Timestamptz` for UTC timestamps (createdAt, updatedAt)
- [ ] Unique constraints match DB design spec
- [ ] Foreign keys have proper `onDelete` behavior

✅ **SHOULD**:
- [ ] Indexes are defined for common queries
- [ ] Array fields (`tags`, `themeIds`) have GIN indexes
- [ ] `deletedAt` is optional (v0.1 uses physical deletion)

## Common Operations

### Reset Database (Development Only)
```bash
deno task db:reset  # Drop + recreate + migrate
```

### Generate Prisma Client Only
```bash
deno task db:generate
```

### Prisma Studio (DB GUI)
```bash
deno task db:studio
```

## Gotchas

1. **runtime = "deno" は必須**: Prisma 7 では `runtime = "deno"` を明示しないと、Node.js 向けのクライアントが生成されます。

2. **UUIDv7**: Prisma doesn't support `uuid_generate_v7()` natively. Generate IDs in application code before `create()`.
   ```typescript
   import { uuidv7 } from "npm:uuidv7@1";

   const theme = await prisma.theme.create({
     data: {
       id: uuidv7(), // アプリ側で生成
       userId: user.id,
       name: "新テーマ",
       goal: "目標",
     },
   });
   ```

3. **Array Defaults**: Use `@default([])` for array fields to avoid null checks.

4. **CHECK Constraints**: Prisma schema doesn't support CHECK constraints. Add them manually in migration SQL.

5. **Deno Deploy Auto-Migration**: Deno Deploy can automatically run `prisma migrate deploy` after build. Configure in `deno.json`:
   ```json
   {
     "tasks": {
       "build": "npm:vite build && deno task db:migrate",
       "db:migrate": "prisma migrate deploy"
     }
   }
   ```

## Prisma Client Usage (Deno)

```typescript
// lib/server/db.ts
import { PrismaClient } from "../generated/prisma/index.ts";

let prisma: PrismaClient;

if (Deno.env.get("DENO_DEPLOYMENT_ID")) {
  // 本番環境（Deno Deploy）
  prisma = new PrismaClient();
} else {
  // 開発環境（ホットリロード対応）
  if (!globalThis.__prisma) {
    globalThis.__prisma = new PrismaClient();
  }
  prisma = globalThis.__prisma;
}

export default prisma;
```

## References

- DB Design Spec: `docs/spec/learning_log_meta_note_アプリ_db設計（draft_v_0.md:44`
- Deno Deploy + Prisma: `docs/tech/deno_deploy_sveltekit_注意点_2025.md:523`
- Prisma Deno Docs: https://www.prisma.io/docs/orm/prisma-client/deployment/edge/deploy-to-deno-deploy
